<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance App</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
    body { background: #f0f4f8; color: #333; padding: 20px; }
    h1 { text-align: center; color: #4e89ff; margin-bottom: 30px; }
    .container { max-width: 500px; margin: auto; }
    .card { background: #fff; padding: 25px 20px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .hidden { display: none; }
    input, button { font-family: inherit; font-size: 16px; margin-top: 8px; padding: 10px; border-radius: 6px; outline: none; border: 1px solid #ccc; }
    input:focus { border-color: #4e89ff; box-shadow: 0 0 5px rgba(78,137,255,0.5); }
    button { background: #4e89ff; color: #fff; border: none; cursor: pointer; transition: 0.3s; }
    button:hover { background: #3866d6; }
    #userid { background: #d0e8ff; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-weight: 500; text-align: center; }
    #table { margin-top: 15px; padding: 10px; border-radius: 6px; background: #f7f9fc; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }
    #table .user { font-weight: 600; margin-right: 5px; }
    #table .text { color: #555; }
    .toggle-link { color: #4e89ff; cursor: pointer; text-decoration: underline; font-size: 14px; display: inline-block; margin-top: 10px; }
    label { display: block; margin-top: 10px; }
    p { margin-top: 5px; color: #555; }
    @media(max-width: 600px){ .container { padding: 0 10px; } input, button { font-size: 14px; } }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #4e89ff; color: #fff; }
  </style>
</head>
<body>

<h1>Attendance App</h1>
<div class="container">

  <!-- LOGIN -->
  <div id="loginfrm" class="card">
    <h2>Login</h2>
    <input type="email" id="login-email" placeholder="Email">
    <input type="password" id="login-password" placeholder="Password">
    <button id="login-btn">Login</button>
    <span class="toggle-link" id="show-register">Don't have an account? Register</span>
  </div>

  <!-- REGISTER -->
  <div id="registerfrm" class="card hidden">
    <h2>Register</h2>
    <input type="text" id="reg-name" placeholder="Full Name">
    <input type="email" id="reg-email" placeholder="Email">
    <input type="password" id="reg-password" placeholder="Password">
    <button id="register-btn">Register</button>
    <span class="toggle-link" id="show-login">Already have an account? Login</span>
  </div>

  <!-- USER INFO -->
  <div id="userid" class="hidden"></div>

  <!-- ATTENDANCE -->
  <div id="attfrm" class="card hidden">
    <h2>Attendance</h2>
    <button id="checkInBtn">Check In</button>
    <button id="checkOutBtn">Check Out</button>
    <button id="logoutBtn">Logout</button>
<button id="deleteBtn">Delete last record</button>

    <div id="table"></div>
  </div>

  <!-- REPORT -->
  <div id="repofrm" class="card hidden">
    <h2>Reports</h2>
    <h3>Daily / Range Report</h3>
    <label>Start Date: <input type="date" id="start-date"></label>
    <label>End Date: <input type="date" id="end-date"></label>
    <button id="reportBtn">Download CSV</button>

    <h3>Monthly Summary</h3>
    <label>Month: <input type="month" id="month"></label>
    <button id="monthlySummaryBtn">Show Summary</button>
    <div id="monthly-summary-table"></div>
  </div>

</div>

<script>
  const BASE_URL = "https://attendence-be-2arx.onrender.com"; // update this

  // ==== TOGGLE LOGIN / REGISTER ====
  document.getElementById("show-register").addEventListener("click", () => {
    document.getElementById("loginfrm").classList.add("hidden");
    document.getElementById("registerfrm").classList.remove("hidden");
  });
  document.getElementById("show-login").addEventListener("click", () => {
    document.getElementById("registerfrm").classList.add("hidden");
    document.getElementById("loginfrm").classList.remove("hidden");
  });

  // ==== AUTH ====
  document.getElementById("login-btn").addEventListener("click", login);
  document.getElementById("register-btn").addEventListener("click", register);

  function register() {
    const data = {
      name: document.getElementById("reg-name").value,
      email: document.getElementById("reg-email").value,
      password: document.getElementById("reg-password").value
    };
    if (!data.name || !data.email || !data.password) return alert("All fields are required");

    fetch(`${BASE_URL}/auth/register`, {
      method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(res => alert(res.msg));
  }

  function login() {
    const data = {
      email: document.getElementById("login-email").value,
      password: document.getElementById("login-password").value
    };
    if (!data.email || !data.password) return alert("Email & password required");

    fetch(`${BASE_URL}/auth/login`, {
      method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(res => {
      if (!res.data) return alert(res.msg);
      localStorage.setItem("user", JSON.stringify(res.data));
      document.getElementById("loginfrm").classList.add("hidden");
      document.getElementById("registerfrm").classList.add("hidden");
      document.getElementById("attfrm").classList.remove("hidden");
      document.getElementById("repofrm").classList.remove("hidden");
      document.getElementById("userid").classList.remove("hidden");
      document.getElementById("userid").innerText = `Logged in as: ${res.data.name}`;
    });
  }

  // ==== GEOLOCATION HELPERS ====
  function getUserLocation(onAllowed) {
    if (!navigator.geolocation) return alert("Geolocation not supported");
    navigator.geolocation.getCurrentPosition(
      (pos) => onAllowed(pos.coords.latitude, pos.coords.longitude),
      () => alert("Location permission is required"),
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  }

  // ==== ATTENDANCE ====
  document.getElementById("checkInBtn").addEventListener("click", () => getUserLocation((lat,lng) => sendAttendance("in",lat,lng)));
  document.getElementById("checkOutBtn").addEventListener("click", () => getUserLocation((lat,lng) => sendAttendance("out",lat,lng)));

  function sendAttendance(type, lat, lng) {
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) return alert("Not logged in");

    const now = new Date();
    const payload = {
      type,
      name: user.name,
      date: now.toISOString().split("T")[0],
      now: now.toLocaleTimeString("en-GB"),
      lat, lng
    };

    fetch(`${BASE_URL}/${type}`, {
      method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(res => {
      alert(res.msg);
      if (res.data) {
        const last = res.data[res.data.length-1];
        document.getElementById("table").innerHTML =
          `<span class="user">${last.name}</span>
           <span class="text">${type==="in"?"Checked In ✅":"Checked Out ✅"}</span>`;
      }
    });
  }

  // ==== REPORT ====
  document.getElementById("reportBtn").addEventListener("click", () => {
    const start = document.getElementById("start-date").value;
    const end = document.getElementById("end-date").value;
    let url = `${BASE_URL}/report`;
    if(start||end) url += `?start=${start}&end=${end}`;
    fetch(url).then(r=>r.blob()).then(blob=>{
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob); a.download="attendance.csv"; a.click();
      URL.revokeObjectURL(a.href);
    });
  });

  // ==== MONTHLY SUMMARY ====
  document.getElementById("monthlySummaryBtn").addEventListener("click", getMonthlySummary);

  function getMonthlySummary() {
    const month = document.getElementById("month").value; // YYYY-MM
    if(!month) return alert("Select month");

    fetch(`${BASE_URL}/summary?month=${month}`)
      .then(res => res.json())
      .then(data => {
        let html = `<table><tr><th>Employee</th><th>Days</th><th>Total Hours</th><th>Late</th><th>Early Leave</th></tr>`;
        for(const name in data) {
          html += `<tr>
            <td>${name}</td>
            <td>${data[name].days}</td>
            <td>${data[name].total_hours.toFixed(2)}</td>
            <td>${data[name].late}</td>
            <td>${data[name].early}</td>
          </tr>`;
        }
        html += `</table>`;
        document.getElementById("monthly-summary-table").innerHTML = html;
      });
  }
// LOGOUT
document.getElementById("logoutBtn").addEventListener("click",()=>{
  localStorage.removeItem("user");
  location.reload();
});

// DELETE LAST RECORD
document.getElementById("deleteBtn").addEventListener("click",()=>{
  const user=JSON.parse(localStorage.getItem("user"));
  if(!user) return alert("Not logged in");
  const date=new Date().toISOString().split("T")[0];
  const type=prompt("Which record to delete? (in/out)");
  if(type!=="in" && type!=="out") return alert("Invalid type");

  fetch(`${BASE_URL}/delete`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name:user.name,date,type})
  }).then(r=>r.json()).then(res=>{
    alert(res.msg);
    document.getElementById("table").innerHTML="";
  });
});

</script>

</body>
</html>



